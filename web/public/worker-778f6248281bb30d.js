(()=>{let t=self;async function o(t){try{console.log("[custom-worker] 알림 읽음 처리: ".concat(t));let o=await fetch("/api/notifications/receipt?notificationId=".concat(t),{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)return void console.error("[custom-worker] Receipt 조회 실패: ".concat(t),o.status);let e=(await o.json()).receiptId;if(!e)return void console.error("[custom-worker] Receipt ID를 찾을 수 없음: ".concat(t));console.log("[custom-worker] Receipt ID: ".concat(e));let n=await fetch("/api/notifications/".concat(e,"/read"),{method:"POST",headers:{"Content-Type":"application/json"}});n.ok?console.log("[custom-worker] 알림 읽음 처리 완료: ".concat(t," (receiptId: ").concat(e,")")):console.error("[custom-worker] 알림 읽음 처리 실패: ".concat(t),n.status)}catch(o){console.error("[custom-worker] 알림 읽음 처리 오류: ".concat(t),o)}}self.addEventListener("push",function(o){console.log("[custom-worker] Push event received:",o);let e={title:"얼티메이트",body:"새로운 알림이 있습니다.",icon:"/icons/icon-192x192.png",badge:"/icons/icon-192x192.png",tag:"default",data:{url:"/"}};if(o.data)try{let t=o.data.json();console.log("[custom-worker] Push payload:",t),e={...e,...t}}catch(t){console.error("[custom-worker] 푸시 데이터 파싱 실패:",t),e.body=o.data.text()||e.body}let n={body:e.body,icon:e.icon,badge:e.badge,tag:e.tag,data:e.data,actions:[{action:"open",title:"확인하기"},{action:"close",title:"닫기"}],requireInteraction:!0,silent:!1,vibrate:[200,100,200],priority:"high",timestamp:Date.now(),renotify:!0,sticky:!0};o.waitUntil(t.registration.showNotification(e.title,n))}),self.addEventListener("message",function(o){console.log("[custom-worker] Message received:",o.data),"TEST_PUSH"===o.data.type&&t.registration.showNotification(o.data.data.title,{body:o.data.data.body,icon:o.data.data.icon,tag:"test"}),"CHECK_SUBSCRIPTION"===o.data.type&&o.waitUntil(t.registration.pushManager.getSubscription().then(e=>{e&&fetch("/api/push/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:o.data.userId,subscription:e.toJSON()})}).then(e=>{e.ok||(console.log("[custom-worker] 구독이 유효하지 않음, 재구독 필요"),t.clients.matchAll().then(t=>{t.forEach(t=>{t.postMessage({type:"SUBSCRIPTION_INVALID",userId:o.data.userId})})}))}).catch(t=>{console.error("[custom-worker] 구독 검증 실패:",t)})})),"CLEAR_CACHE"===o.data.type&&o.waitUntil(caches.keys().then(function(t){return Promise.all(t.map(function(t){return console.log("[custom-worker] Clearing cache:",t),caches.delete(t)}))}).then(function(){return t.clients.matchAll().then(function(t){t.forEach(function(t){t.postMessage({type:"CACHE_CLEARED"})})})})),"UPDATE_SW"===o.data.type&&o.waitUntil(t.registration.update().then(function(){return console.log("[custom-worker] Service worker updated"),t.clients.matchAll().then(function(t){t.forEach(function(t){t.postMessage({type:"SW_UPDATED"})})})}))}),self.addEventListener("notificationclick",function(t){var e,n;if(console.log("[custom-worker] Notification click received."),t.notification.close(),"close"===t.action)return;let c=(null==(e=t.notification.data)?void 0:e.url)||"/",i=null==(n=t.notification.data)?void 0:n.notificationId;console.log("[custom-worker] 알림 클릭 데이터:",{url:c,notificationId:i}),t.waitUntil(Promise.all([i?o(i):Promise.resolve(),clients.matchAll({type:"window",includeUncontrolled:!0}).then(function(t){for(let o=0;o<t.length;o++){let e=t[o];if(e.url.includes(self.location.origin)&&"focus"in e)return e.navigate(c),e.focus()}if(clients.openWindow)return clients.openWindow(c)})]))}),self.addEventListener("install",function(o){console.log("[custom-worker] Service worker installed"),t.skipWaiting()}),self.addEventListener("sync",function(o){console.log("[custom-worker] Background sync event:",o.tag),"background-sync"===o.tag&&o.waitUntil((console.log("[custom-worker] Performing background sync"),fetch("/api/profile/check",{method:"GET",headers:{"Cache-Control":"no-cache"},cache:"no-store"}).then(t=>{if(401===t.status)return console.log("[custom-worker] 사용자가 인증되지 않음, 백그라운드 동기화 건너뛰기"),null;if(!t.ok)throw Error("Profile check failed: ".concat(t.status));return fetch("/api/notifications/check",{method:"GET",headers:{"Cache-Control":"no-cache"},cache:"no-store"})}).then(t=>{if(!t)return null;if(t.ok)return t.json();throw Error("Background sync failed")}).then(o=>{if(o&&o.hasNewNotifications)return t.registration.showNotification("새 알림",{body:"확인하지 않은 알림이 있습니다.",icon:"/icons/icon-192x192.png",badge:"/icons/icon-192x192.png",tag:"background-sync",requireInteraction:!0,vibrate:[200,100,200],priority:"high"})}).catch(t=>{console.error("[custom-worker] Background sync error:",t)})))}),self.addEventListener("activate",function(o){console.log("[custom-worker] Service worker activated"),o.waitUntil(Promise.all([t.clients.claim(),t.registration.sync.register("background-sync"),caches.keys().then(function(t){return Promise.all(t.map(function(t){return t.includes("dev")||t.includes("old-")?(console.log("[custom-worker] Deleting outdated cache:",t),caches.delete(t)):Promise.resolve()}))})]))})})();